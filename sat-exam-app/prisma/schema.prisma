generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  password       String
  name           String
  role           UserRole
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  studentClasses ClassStudent[]
  teacherClasses Class[]        @relation("TeacherClasses")
  studentExams   StudentExam[]

  @@map("users")
}

model Class {
  id          String         @id @default(cuid())
  name        String
  description String?
  code        String         @unique
  teacherId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  students    ClassStudent[]
  teacher     User           @relation("TeacherClasses", fields: [teacherId], references: [id], onDelete: Cascade)
  exams       Exam[]

  @@map("classes")
}

model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  joinedAt  DateTime @default(now())
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@map("class_students")
}

model Exam {
  id               String        @id @default(cuid())
  title            String
  description      String?
  type             ExamType
  status           ExamStatus    @default(DRAFT)
  duration         Int
  startTime        DateTime?
  endTime          DateTime?
  pdfUrl           String?
  classId          String

  shuffleQuestions Boolean       @default(true)
  shuffleAnswers   Boolean       @default(true)
  maxViolations    Int           @default(3)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  class            Class         @relation(fields: [classId], references: [id], onDelete: Cascade)
  questions        Question[]
  studentExams     StudentExam[]

  @@map("exams")
}

model Question {
  id             String          @id @default(cuid())
  examId         String
  content        String
  optionA        String
  optionB        String
  optionC        String
  optionD        String
  correctAnswer  String
  points         Int             @default(1)
  order          Int
  exam           Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  studentAnswers StudentAnswer[]

  @@map("questions")
}

model StudentExam {
  id             String            @id @default(cuid())
  studentId      String
  examId         String
  startedAt      DateTime?
  submittedAt    DateTime?
  score          Float?
  maxScore       Float?
  status         StudentExamStatus @default(NOT_STARTED)
  violationCount Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  answers        StudentAnswer[]
  exam           Exam              @relation(fields: [examId], references: [id], onDelete: Cascade)
  student        User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  violations     Violation[]

  @@unique([studentId, examId])
  @@map("student_exams")
}

model StudentAnswer {
  id             String      @id @default(cuid())
  studentExamId  String
  questionId     String
  selectedAnswer String?
  isCorrect      Boolean?
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  studentExam    StudentExam @relation(fields: [studentExamId], references: [id], onDelete: Cascade)

  @@unique([studentExamId, questionId])
  @@map("student_answers")
}

model Violation {
  id            String      @id @default(cuid())
  studentExamId String
  type          String
  description   String?
  timestamp     DateTime    @default(now())
  studentExam   StudentExam @relation(fields: [studentExamId], references: [id], onDelete: Cascade)

  @@map("violations")
}

enum UserRole {
  TEACHER
  STUDENT
}

enum ExamType {
  MIDTERM
  FINAL
  QUIZ
}

enum ExamStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  COMPLETED
}

enum StudentExamStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
}
